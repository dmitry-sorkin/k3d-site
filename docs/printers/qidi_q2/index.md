---
title: Доработки QIDI Q2
description: Исправление проблем принтера
icon: material/printer-3d
---

# QIDI Q2

!!! warning "Статья находится в стадии написания и тестирования. Если вы решитесь действовать по этой статье, то вы берёте на себя полную отвественность за все последствия"

!!! note "При возникновении проблем пишите в [телеграм-чат K3D](https://t.me/K_3_D){ target="_blank" }"

## Избавление от эхо

### Описание проблемы

![](./pics/q2_echo_cube.jpg)

Штатно у Qidi Q2 есть сразу 2 проблемы с калибровкой Input Shaping'а:

Превая - для штатного акселерометра сильно занижена частота дискретизации (400гц вместо 1600гц), из-за чего тот снимает показания неправильно, с большим количеством артефактов. Из-за них автокалибровщик не может подобрать оптимальные шейперы, и рекомендует неоптимальные, при которых остаётся большое количество эхо.

Вторая - направляющие оси Y недостаточно жёсткие и прогибаются при движении каретки по оси Х. Это приводит к тому, что резонансная частота, которую должен гасить Input Shaping, меняется в зависимости от координаты по оси Y. Иными словами, даже если мы подберём оптимальный шейпер в центре стола, то он будет нормально работать только в центре. На деталях, части которых расположены вблизи краёв, будет сильное эхо.

Был придуман способ откалибровать Input Shaping таким образом, чтобы заниженная частота дискретизации слабо влияла на результат, а также можно было учесть данные с разных точек по оси Y. Но, к сожалению, тесты полученных шейперов показали, что они, хоть и дают достаточно большие максимальные ускорения, но гасят вибрации не полностью. То есть на деталях из глянцевых материалов эхо видно будет. Поэтому на данный момент эта методика не рекомендуется. Вместо этого предлагается просто установить достаточно "жирный" шейпер, который загасит все вибрации начиная примерно с 50Гц. С ним максимальные ускорения будут немного ниже, но зато не надо ничего калибровать и поверхность будет гладкая.

### Рекомендуемый способ исправления

1. Натяните ремни как сказано в инструкции к принтеру;
2. В веб-интерфейсе принтера перейдите в раздел `Конфигурация` и откройте `printer.cfg`;
3. Промотайте в конец файла. Там будет много серых строк, начинающихся с `#*#`. Среди них найдите раздел `[input_shaper]`, который должен выглядеть примерно так:
```
#*# [input_shaper]
#*# shaper_type_x = zv
#*# shaper_freq_x = 50.1
#*# shaper_type_y = zv
#*# shaper_freq_y = 51.3
```
4. Поменяйте значения на следующие:
```
#*# [input_shaper]
#*# shaper_type_x = 2hump_ei
#*# shaper_freq_x = 80
#*# shaper_type_y = 2hump_ei
#*# shaper_freq_y = 80
```
5. Найдите раздел `[printer]`;
6. Поменяйте значение параметра `square_corner_velocity` на 5;
7. Нажмите кнопку `Сохранить и перезагрузить`

Всё, можете печатать с максимальными ускорениями до ~7200 мм/с^2.

Если небольшое эхо на деталях останется, то уменьшите частоты до 75 или 70Гц. Максимальные ускорения при этом составят ~6300 и ~5500 мм/с^2.

### Ручной подбор шейперов по АЧХ

![](./pics/q2_limit_max_freq_result.png)

!!! note "Этот метод не рекомендуется для рядового пользователя. Он оставлен в статье только для опытных пользователей, которые хотят попробовать настроить свой принтер получше, или проанализировать его работу"

#### Подготовка

Qidi, пытаясь решить проблему с плохо калибрующимся Input Shaping'ом, внесли в прошивку несколько дёрти хаков. Они, к сожалению, проблему не исправляют, а только лишь немного маскируют. Но, если мы решим проблему, то эти хаки приведут к подбору неоптимальных шейперов, при которых может быть довольно высокий уровень остаточных вибраций. Чтобы такого не произошло, надо убрать это из прошивки, вернув её работу к штатной:

1. В веб-интерфейсе принтера зайдите во вкладку `Конфигурация` и откройте файл `printer.cfg`;
2. Найдите раздел `resonance_tester`;
3. Закомментируйте строки `accel_per_hz` и `max_smoothing`;
4. Найдите раздел `printer`;
5. Измените значение параметра `square_corner_velocity` на 5;
6. Сохраните изменения и перезапустите прошивку.

Для правильной калибровки Input Shaping'а на Q2 придётся пользоваться штатным скриптом клиппера, под который в системе не установлены нужные зависимости. Поэтому необходимо будет их установить. Делается это один раз, потом можно будет генерировать графики сколько угодно раз, пока не переустановите прошивку.

1. Откройте терминал на вашем компьютере. Например, на Windows можно воспользоваться встроенным в систему PowerShell;
2. Подключитесь к принтеру по SSH. Для этого введите команду:
```
ssh mks@ip_адрес_принтера
```
IP можно посмотреть прямо через экран принтера, он, обычно, имеет вид `192.168.xxx.xxx`;
3. Спросит пароль. Введите `makerbase`. Символы при этом не отображаются, но знаки вводятся;
4. Введите команду
```
pip install numpy matplotlib
```
5. Со всем соглашайтесь и ждите окончания установки. Если спросит пароль администратора, то введите `makerbase`. После окончания установки дополнительных действий не требуется.

#### Получение данных калибровки

Из-за того, что направляющим оси Y не хватает жёсткости, частота шейпера по оси X будет зависеть от положения печатающей головы. К примеру, на моём принтере при голове в центре стола рекомендованный шейпер `MZV 51hz`, а при голове вблизи переднего края стола `MZV 73hz`. Если мы применим шейпер, снятый в центре стола, и попробуем с ним попечатать, то на мелких деталях, расположенных в центре стола, всё будет хорошо. Но на крупных деталях, стенки которых располагаются далеко от центра, будет эхо. Поэтому необходимо подобрать шейпер, который будет эффективно гасить вибрации и в центре стола, и вблизи края. Тогда эхо не будет нигде.

Второй проблемой являются артефакты из-за заниженной частоты дискретизации штатного акселерометра - те самые вибрации на низких и высоких частотах, которые на АЧХ есть, но на самом деле их нет. К счастью, от этих артефактов очень легко избавиться. Надо всего-лишь ограничить максимальную тестируемую частоту до 100Гц. В рамках данного гайда это делается внутри команд.

1. Выполните автопарковку `G28`;
2. Снимите данные по оси Х в трёх точках: по центру, на пол пути к краю, и около края:
```
TEST_RESONANCES AXIS=X FREQ_START=20 FREQ_END=100 OUTPUT=raw_data POINT=135,135,10
```
```
TEST_RESONANCES AXIS=X FREQ_START=20 FREQ_END=100 OUTPUT=raw_data POINT=135,70,10
```
```
TEST_RESONANCES AXIS=X FREQ_START=20 FREQ_END=100 OUTPUT=raw_data POINT=135,5,10
```
3. Снимите данные по оси Y 
```
TEST_RESONANCES AXIS=Y FREQ_START=20 FREQ_END=100 OUTPUT=raw_data POINT=135,135,10
```

#### Построение АЧХ

Теперь необходимо будет полученные "сырые" данные скормить скрипту, который строит амплитудно-частотные характеристики. Для этого:

1. Подключитесь к принтеру по SSH `ssh mks@ip_адрес_принтера`, пароль `makerbase`;
2. Создайте папку `shapers`, в которой потом появятся файлы:
```
mkdir ~/printer_data/config/shapers
```
3. Введите команду
```
~/klipper/scripts/calibrate_shaper.py /tmp/raw_data_x*.csv -o ~/printer_data/config/shapers/x.png
```
4. Введите команду
```
~/klipper/scripts/calibrate_shaper.py /tmp/raw_data_y*.csv -o ~/printer_data/config/shapers/y.png
```
5. Зайдите в веб-интерфейс принтера, в раздел `Конфигурация`. Там должна появиться папка `shapers`. В ней вы найдёте сгенерированные амплитудно-частотные характеристики. На них в правом-верхнем углу будут указаны подобранные автоподборщиком шейперы. Жирным выделен рекомендуемый шейпер;
6. Перейдите в раздел `Конфигурация` и откройте `printer.cfg`;
7. Промотайте в конец файла. Там будет много серых строк, начинающихся с `#*#`. Среди них найдите раздел `[input_shaper]`, который должен выглядеть примерно так:
```
#*# [input_shaper]
#*# shaper_type_x = zv
#*# shaper_freq_x = 50.1
#*# shaper_type_y = zv
#*# shaper_freq_y = 51.3
```
Поменяйте типы и частоты шейперов в этом разделе на рекомендованные в АЧХ;
9. Сохраните и перезагрузитесь

## Адаптивная карта высот стола

Адаптивная карта высот стола позволяет снимать карту высот только в тех зонах, где будет идти печать. Это позволяет тратить меньше времени на подготовку к печати, а также улучшает первый слой. В штатной конфигурации QIDI поломали работу адаптивной карты высот стола, после чего выключили её. Но её можно довольно легко починить:

1. Откройте терминал на вашем компьютере. Например, на Windows можно воспользоваться встроенным в систему PowerShell;
2. Подключитесь к принтеру по SSH. Для этого введите команду:
```
ssh mks@ip_адрес_принтера
```
IP можно посмотреть прямо через экран принтера, он, обычно, имеет вид `192.168.xxx.xxx`;
3. Спросит пароль. Введите `makerbase`. Символы при этом не отображаются, но знаки вводятся;
4. Удалите поломанную версию плагина KAMP:
```
sudo rm -rf ~/Klipper-Adaptive-Meshing-Purging
```
```
sudo rm -rf ~/printer_data/config/KAMP
```
```
sudo rm -rf ~/printer_data/config/KAMP_settings.cfg
```
Если спросит пароль, то введите `makerbase`. Файлы не обязательно удалять. Если хотите, можете переименовать их любым удобным вам способом;
5. Установите git:
```
sudo apt update
```
```
sudo apt install git
```
Со всем соглашайтесь. Если спросит пароль, то введите `makerbase`;
6. Установите чистую версию KAMP:
```
cd ~/
```
```
git clone https://github.com/kyleisah/Klipper-Adaptive-Meshing-Purging.git
```
```
ln -s ~/Klipper-Adaptive-Meshing-Purging/Configuration printer_data/config/KAMP
```
```
cp ~/Klipper-Adaptive-Meshing-Purging/Configuration/KAMP_Settings.cfg ~/printer_data/config/KAMP_Settings.cfg
```
7. Зайдите в веб-интерфейс принтера и во вкладке `Конфигурация` найдите и откройте файл `KAMP_Settings.cfg`;
8. В нём раскомментируйте (уберите `#` в начале строки) строку `[include ./KAMP/Adaptive_Meshing.cfg]`;
9. [Опционально] если хотите пользоваться адаптивной прочисткой сопла, то раскомментируйте еще и строку `[include ./KAMP/Line_Purge.cfg]`;
10. Установите значение параметра `variable_mesh_margin` на 10;
11. Установите значение параметра `variable_fuzz_amount` на 2;
12. Нажмите кнопку `Сохранить и перезапустить`

После этого адаптивная карта высот стола начнёт работать автоматически, никаких дополнительных действий и настроек не требуется. Адаптивная линия прочистки работать сама по себе не будет. Для неё надо будет еще исправить макрос старта печати, заменив вручную прописанную линию прочистки на макрос `LINE_PURGE`.

## Макросы старта и окончания печати

Стоковые макросы старта и окончания печати составлены неоптимально, и имеют ряд проблем:

- Инициализация печати занимает очень много времени;
- Парковка, выравнивание стола и снятие карты высот происходят до окончательного прогрева стола, что приводит к дефектам первого слоя;
- Половина логики инициализации/окончания печати прописана в макросе, половина в стартовом скрипте. Это нивелирует плюсы что одного, что другого подхода;
- В стартовом скрипте происходит обрезание прутка. Мало того, что для принтеров без QIDI Box это бесполезно, так еще и изнашивает нож.

Поэтому я составил макросы старта и окончания печати, которые призваны решить эти проблемы.

!!! warning "Эти макросы находятся в стадии тестирования. Используя их вы полностью берёте на себя ВСЕ риски"
!!! warning "Эти макросы не подходят к принтерам с QIDI Box"
!!! note "Если вы использовали эти макросы, и они вам понравились, или у вас есть какие-то претензии, то напишите об этом в [телеграм-чат K3D](https://t.me/K_3_D){ target="_blank" }. Обратная связь ускорит тестирование и поможет найти и устранить проблемы"

### Макросы

Скопируйте эти макросы в конец файла gcode_macro.cfg, после чего сохранитесь и перезгрузите прошивку.

```
[gcode_macro POEHALI]
gcode:
    {% set target_bed = params.B|int %}
    {% set target_extruder = params.H|int %}
    {% set target_chamber = params.C|default("0")|int %}
    SAVE_VARIABLE VARIABLE=qdc_ai_error_code VALUE='""'
    DISABLE_ALL_SENSOR
    CLEAR_PAUSE
    M140 S{ target_bed }
    M141 S{ target_chamber }
    G28
    M141 S{ target_chamber } # защита от багов. Не трогать
    CLEAR_NOZZLE HOTEND={ target_extruder }
    M190 S{ target_bed }
    M191 S{ target_chamber }
    G28
    M141 S{ target_chamber } # защита от багов. Не трогать
    Z_TILT_ADJUST
    M141 S{ target_chamber } # защита от багов. Не трогать
    BED_MESH_CALIBRATE
    M191 S{ target_chamber } # защита от багов. Не трогать
    M109 S{ target_extruder }
    M220 S100
    M221 S100
    G90
    M83
    G92 E0
    ENABLE_ALL_SENSOR
    set_zoffset
    LINE_PURGE

[gcode_macro HAROSH]
gcode:
    M141 S0
    M140 S0
    M104 S0
    DISABLE_ALL_SENSOR
    G1 E-3 F1800
    G91
    G1 Z3 F600
    G90
    G1 X90 F18000
    G1 Y270 F18000
    {% if printer.toolhead.position.z < printer['gcode_macro PRINTER_PARAM'].max_z_position / 2 %}
        G1 Z{ printer['gcode_macro PRINTER_PARAM'].max_z_position / 2 }
    {% endif %}
    M220 S100
    G90
    M83
```

!!! warning "Если вы не переустанавливали KAMP, то удалите из макроса `POEHALI` строку `LINE_PURGE`. Прочистку сопла в таком случае выполняйте с помощью печати юбки"

### Стартовый и конечный G-коды

1. Откройте слайсер, которым планируете пользоваться. Макросы протестированы в PrusaSlicer и OrcaSlicer, но, возможно, будут работать и в других основанных на этих двух;
2. Зайдите в профиль принтера, в раздел `G-код принтера`;
3. Замените стартовый G-код на:
```
POEHALI H={first_layer_temperature[0]} B={first_layer_bed_temperature[0]} C={chamber_temperature[0]}
```
4. Замените завершающий G-код на:
```
HAROSH
```
5. Сохраните профиль

## В случае возникновения проблем

К сожалению, некоторые участники профильных чатов по принтерам Qidi испытывают колоссальные душевные страдания, когда к ним приходят с проблемами, касающимися моих инструкций. Поэтому, если вы пытались что-то сделать со своим принтером, и у вас не получилось, то лучше обратиться в мой [телеграм-чат K3D](https://t.me/K_3_D){ target="_blank" }. Таким образом можно будет убить сразу двух зайцев. Во-первых, я узнаю о наличии какой-то проблемы в инструкции и смогу её исправить. А, во-вторых, мы сохраним душевное спокойствие спокойствие самых нежных из обитателей профильных чатов.